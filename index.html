<html>
<head>
    <title>Kremlin towers</title>
    <meta charset="utf-8" />
<script src="phaser.js"></script>
<script type="text/javascript">
    var config = {
        type: Phaser.AUTO,
        width: 480,
        height: 640,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 200}
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    var level = {
        playerTower: 
            {
                x: 50,
                y: 430
            },
        towers: [
            {
                x: 100,
                y: 450
            },
            {
                x: 200,
                y: 450
            },
            {
                x: 300,
                y: 450
            },
        ]
    };
    var state = {
        cannon : {
            x: 200,
            y: 200
        },
        active: true,
        inaims: false,
        aimlength: 0,
        lastFireTime: 0
    };

    var vector;
    var aimline;

    var game = new Phaser.Game(config);

    var cannon;
    function preload() {
        console.info("Loading images…");
        this.load.image('bullet', 'assets/bullet.png');
        this.load.image('cannon', 'assets/cannon.png');
        this.load.image('background', 'assets/background.jpg');
        this.load.image('tower', 'assets/tower.png')
    }
    function create() {
        this.add.tileSprite(240, 320, 480, 640, 'background');

        // Создание башни игрока

        createTower(this,level.playerTower);

        for (let tower of level.towers) {
            this.add.image(tower.x, tower.y, 'tower');
        }
        vector = this.add.graphics({ lineStyle: { width: 4, color: 0xaa00aa } });
    }
    function update () {
        // set the angle according to the mouse pointer
        if (this.input.activePointer.isDown && state.active) {
            state.inaims = true;
            mouseX = this.input.x;
            mouseY = this.input.y;
            cannonX = state.cannon.x;
            cannonY = state.cannon.y;
            var aimline = new Phaser.Geom.Line(cannonX, cannonY, mouseX, mouseY);
            vector.clear()
            vector.strokeLineShape(aimline);
            realAngle = Math.atan2(mouseY - cannonY, mouseX - cannonX) * 180 / Math.PI;
            unrealAngle = realAngle + 180;
            console.info(unrealAngle);
            if ((unrealAngle <= 360 && unrealAngle >= 270) || (unrealAngle >= 0 && unrealAngle <=90)) {
                cannon.angle = unrealAngle;
                state.aimlength = Phaser.Geom.Line.Length(aimline).toFixed(0);
            }
        } else if (state.inaims == true) { 
            fire(state.aimlength);
            state.active = false;
            state.lastFireTime = Date.now();
            state.inaims = false;
        }


        if (Date.now() - state.lastFireTime > 1000) {
            state.active = true;
        }
    }

    function createTower(obj, tower) {
        obj.add.image(tower.x, tower.y, 'tower');
        state.cannon.x = tower.x + 20;
        state.cannon.y = tower.y + 2;
        cannon = obj.add.sprite(state.cannon.x, state.cannon.y, 'cannon');
        cannon.angle = 0;

    }


    function fire(aa) {
        console.info("Boom? " + aa);
    }

</script>
</head>
<body>
</body>
</html>
